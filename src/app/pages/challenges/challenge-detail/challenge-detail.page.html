<ion-header>
  <app-beatdown-breakdown-banner></app-beatdown-breakdown-banner>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/challenges"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ challenge?.name || 'Challenge' }}</ion-title>
    <ion-buttons slot="end">
      <ion-button
        *ngIf="challenge && isOwner()"
        fill="clear"
        (click)="editChallenge()">
        <ion-icon slot="icon-only" name="create-outline"></ion-icon>
      </ion-button>
      <ion-button
        *ngIf="challenge && isOwner()"
        fill="clear"
        color="danger"
        (click)="deleteChallenge()"
        [disabled]="isDeleting">
        <ion-spinner *ngIf="isDeleting" name="crescent"></ion-spinner>
        <ion-icon *ngIf="!isDeleting" slot="icon-only" name="trash-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="challenge-detail-container" *ngIf="challenge">
    <!-- Challenge Details -->
    <ion-card class="details-card">
      <ion-card-header>
        <div class="card-header-row">
          <div class="card-title-section">
            <div class="title-row">
              <ion-card-title>{{ challenge.name }}</ion-card-title>
              <ion-chip *ngIf="challenge.isPrivate" color="medium" class="private-chip">
                <ion-icon name="lock-closed-outline"></ion-icon>
                <ion-label>Private</ion-label>
              </ion-chip>
            </div>
            <ion-card-subtitle>{{ getDateRange() }}</ion-card-subtitle>
          </div>
          <ion-chip *ngIf="participants.length > 0" class="participants-chip">
            <ion-icon name="people-outline"></ion-icon>
            <ion-label>{{ participants.length }}</ion-label>
          </ion-chip>
        </div>
      </ion-card-header>
      <ion-card-content>
        <p class="description">{{ challenge.description }}</p>
        <div class="challenge-details">
          <div class="detail-item">
            <ion-icon name="stats-chart-outline"></ion-icon>
            <span><strong>Tracking:</strong> {{ getMetricsList() }}</span>
          </div>
          <div class="detail-item">
            <ion-icon name="swap-vertical-outline"></ion-icon>
            <span><strong>Sort by:</strong> {{ getSortByLabel() }}</span>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Join Challenge CTA -->
    <div class="join-section" *ngIf="!isParticipant && challenge?.requireJoining !== false">
      <ion-button
        expand="block"
        (click)="joinChallenge()"
        [disabled]="isLoading || isJoining">
        <ion-spinner *ngIf="isJoining" name="crescent"></ion-spinner>
        <ion-icon *ngIf="!isJoining" slot="start" name="person-add-outline"></ion-icon>
        <span *ngIf="!isJoining">{{ user ? 'Join Challenge' : 'Sign in to Join Challenge' }}</span>
        <span *ngIf="isJoining">Joining...</span>
      </ion-button>
    </div>

    <!-- Leaderboard -->
    <div class="leaderboard-section">
      <!-- Joined Participants Leaderboard -->
      <div class="leaderboard-subsection">
        <div class="leaderboard-header">
          <h2>Participants</h2>
          <ion-button
            *ngIf="isOwner() && challenge?.requireJoining !== false"
            fill="clear"
            size="small"
            (click)="openAddParticipantModal()">
            <ion-icon slot="start" name="person-add-outline"></ion-icon>
            Add PAX
          </ion-button>
        </div>
        <ion-spinner *ngIf="isLoading" name="crescent"></ion-spinner>

        <div *ngIf="!isLoading && leaderboard.length === 0" class="empty-leaderboard">
          <p *ngIf="challenge?.requireJoining !== false">No participants yet. Be the first to join!</p>
          <p *ngIf="challenge?.requireJoining === false">No participants have joined yet.</p>
        </div>

        <div *ngIf="!isLoading && leaderboard.length > 0" class="leaderboard-table">
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>Name</th>
                <th *ngIf="challenge.metrics.bds"># of BDs</th>
                <th *ngIf="challenge.metrics.uniqueAos"># of AOs</th>
                <th *ngIf="challenge.metrics.qs"># of Qs</th>
                <th *ngIf="challenge.metrics.doubleDowns"># of DDs</th>
                <th *ngIf="isOwner() || (user && isParticipant)" class="actions-column">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let entry of leaderboard; let i = index; trackBy: trackByLeaderboardEntry"
                  [class.current-user]="user && (entry.userId === user.email || entry.userId === user.uid)">
                <td class="rank">{{ i + 1 }}</td>
                <td class="name">
                  <div class="pax-cell" *ngIf="entry.paxName; else userIdDisplay">
                    <app-pax-avatar [name]="entry.paxName" [size]="32" [clickable]="true"></app-pax-avatar>
                    <app-pax-name [name]="entry.paxName"></app-pax-name>
                  </div>
                  <ng-template #userIdDisplay>
                    {{ entry.userId }}
                  </ng-template>
                </td>
                <td *ngIf="challenge.metrics.bds" class="metric">{{ entry.bds }}</td>
                <td *ngIf="challenge.metrics.uniqueAos" class="metric">{{ entry.uniqueAos }}</td>
                <td *ngIf="challenge.metrics.qs" class="metric">{{ entry.qs }}</td>
                <td *ngIf="challenge.metrics.doubleDowns" class="metric">{{ entry.doubleDowns }}</td>
                <td *ngIf="isOwner() || (user && (entry.userId === user.email || entry.userId === user.uid))" class="actions">
                  <ion-button
                    fill="clear"
                    size="small"
                    color="danger"
                    (click)="removeParticipant(entry.userId)"
                    [disabled]="removingParticipant === entry.userId">
                    <ion-spinner *ngIf="removingParticipant === entry.userId" name="crescent"></ion-spinner>
                    <ion-icon *ngIf="removingParticipant !== entry.userId" slot="icon-only" name="close-circle-outline"></ion-icon>
                  </ion-button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Non-Joined Qualifying PAX Leaderboard (only when requireJoining is false) -->
      <div class="leaderboard-subsection qualifying-pax-subsection" *ngIf="nonJoinedLeaderboard.length > 0">
        <div class="leaderboard-header">
          <h2>Qualifying PAX (Not Joined)</h2>
          <ion-button
            *ngIf="!isLoading && nonJoinedLeaderboard.length > 0 && isOwner()"
            fill="solid"
            size="small"
            color="primary"
            (click)="addAllNonJoinedParticipants()"
            [disabled]="isAddingAll">
            <ion-spinner *ngIf="isAddingAll" name="crescent"></ion-spinner>
            <ion-icon *ngIf="!isAddingAll" slot="start" name="person-add-outline"></ion-icon>
            <span *ngIf="!isAddingAll">Add All</span>
            <span *ngIf="isAddingAll">Adding...</span>
          </ion-button>
        </div>

        <div *ngIf="!isLoading && nonJoinedLeaderboard.length > 0" class="leaderboard-table">
          <table>
            <thead>
              <tr>
                <th>Rank</th>
                <th>Name</th>
                <th *ngIf="challenge.metrics.bds"># of BDs</th>
                <th *ngIf="challenge.metrics.uniqueAos"># of AOs</th>
                <th *ngIf="challenge.metrics.qs"># of Qs</th>
                <th *ngIf="challenge.metrics.doubleDowns"># of DDs</th>
                <th *ngIf="isOwner()" class="actions-column">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let entry of nonJoinedLeaderboard; let i = index; trackBy: trackByLeaderboardEntry"
                  [class.current-user]="user && (entry.userId === user.email || entry.userId === user.uid)">
                <td class="rank">{{ i + 1 }}</td>
                <td class="name">
                  <div class="pax-cell" *ngIf="entry.paxName; else userIdDisplay">
                    <app-pax-avatar [name]="entry.paxName" [size]="32" [clickable]="true"></app-pax-avatar>
                    <app-pax-name [name]="entry.paxName"></app-pax-name>
                  </div>
                  <ng-template #userIdDisplay>
                    {{ entry.userId }}
                  </ng-template>
                </td>
                <td *ngIf="challenge.metrics.bds" class="metric">{{ entry.bds }}</td>
                <td *ngIf="challenge.metrics.uniqueAos" class="metric">{{ entry.uniqueAos }}</td>
                <td *ngIf="challenge.metrics.qs" class="metric">{{ entry.qs }}</td>
                <td *ngIf="challenge.metrics.doubleDowns" class="metric">{{ entry.doubleDowns }}</td>
                <td *ngIf="isOwner()" class="actions">
                  <ion-button
                    fill="clear"
                    size="small"
                    color="primary"
                    (click)="addParticipantFromLeaderboard(entry)"
                    [disabled]="addingParticipant === entry.userId">
                    <ion-spinner *ngIf="addingParticipant === entry.userId" name="crescent"></ion-spinner>
                    <ion-icon *ngIf="addingParticipant !== entry.userId" slot="icon-only" name="add-circle-outline"></ion-icon>
                  </ion-button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="challengeLoading" class="loading-state">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Loading challenge...</p>
  </div>

  <div *ngIf="!challengeLoading && !challenge" class="error-state">
    <ion-icon name="alert-circle-outline"></ion-icon>
    <h3>Challenge not found</h3>
    <ion-button (click)="goBack()">
      Back to Challenges
    </ion-button>
  </div>
</ion-content>
